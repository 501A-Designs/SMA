var firebaseConfig={apiKey:"AIzaSyClYBau_KYGEiitdBo1KSJCDfy-8BZda0E",authDomain:"share-my-activity.firebaseapp.com",databaseURL:"https://share-my-activity.firebaseio.com",projectId:"share-my-activity",storageBucket:"share-my-activity.appspot.com",messagingSenderId:"966863510348",appId:"1:966863510348:web:41b43bd09ccd244c058de9",measurementId:"G-YJJK1ZL449"};firebase.initializeApp(firebaseConfig),firebase.analytics();const auth=firebase.auth(),txtWebsitePass=document.getElementById("txtWebsitePassword"),txtPass=document.getElementById("txtPassword"),btnWebsiteVerify=document.getElementById("btnWebsiteVerify"),btnLogin=document.getElementById("btnLogin"),btnLogout=document.getElementById("btnLogout"),provider=new firebase.auth.GoogleAuthProvider;btnLogout.onclick=()=>auth.signOut();let radios=document.getElementsByName("activityType"),loBoxes=document.getElementsByName("loType"),postCollection=document.querySelector("#postCollection"),announcePostCollection=document.querySelector("#announcePosts");const db=firebase.firestore();function createPost(doc){let div=document.createElement("div"),section=document.createElement("section"),time=document.createElement("time"),span=document.createElement("span"),h3=document.createElement("h3"),h5=document.createElement("h5"),hr=document.createElement("hr"),pre=document.createElement("pre"),like=document.createElement("button"),view=document.createElement("button");time.textContent=doc.data().createdAt,span.textContent=doc.data().postType,h3.textContent=doc.data().postName,h5.textContent=doc.data().postAuthor,pre.textContent=doc.data().postContent,like.innerHTML="<span class='material-icons' style='font-size:16px'>thumb_up</span> "+doc.data().postLike,view.innerHTML="<span class='material-icons'>sticky_note_2</span>";var exp=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,text=pre.textContent.replace(exp,"<a target='_blank' href='$1'>URLリンク↗</a>"),exp2=/(^|[^\/])(www\.[\S]+(\b|$))/gim;pre.innerHTML=text.replace(exp2,"$1<a target='_blank' href='http://$2'>URLリンク↗</a>"),"CAS"===span.textContent?(span.setAttribute("class","casMiniTag"),div.setAttribute("class","post")):(span.setAttribute("class","saaMiniTag"),div.setAttribute("class","post")),like.setAttribute("class","likeBtn"),view.setAttribute("class","viewPostBtn"),div.appendChild(time),div.appendChild(span),div.appendChild(view),div.appendChild(h3),div.appendChild(h5),div.appendChild(hr),div.appendChild(pre),div.appendChild(like),view.onclick=()=>{var newWindow;window.open("","MsgWindow","width=400,height=200").document.write(doc.data().postContent)},like.onclick=()=>{const likeIncrement=firebase.firestore.FieldValue.increment(1);db.collection("posts").doc(doc.id).update({postLike:likeIncrement}).catch((function(error){console.log("Error getting documents: ",error)})),div.setAttribute("style","animation: likeAni 0.7s linear;"),like.innerHTML="<span class='material-icons' style='font-size:16px'>thumb_up</span><span class='material-icons' style='font-size:16px'>done</span>",like.setAttribute("disabled","")},postCollection.appendChild(div)}function createAnnouncePost(aDoc){let div=document.createElement("div"),time=document.createElement("time"),h3=document.createElement("h3"),span=document.createElement("span"),hr=document.createElement("hr"),pre=document.createElement("pre");time.textContent="〜"+aDoc.data().aPostEnd+"まで",h3.textContent=aDoc.data().aPostTitle,span.textContent="投稿日："+aDoc.data().aPostStart,pre.textContent=aDoc.data().aPostContent;var exp=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,text=pre.textContent.replace(exp,"<a target='_blank' href='$1'>$1</a>"),exp2=/(^|[^\/])(www\.[\S]+(\b|$))/gim;pre.innerHTML=text.replace(exp2,"$1<a target='_blank' href='http://$2'>$2</a>"),div.appendChild(time),div.appendChild(h3),div.appendChild(span),div.appendChild(hr),div.appendChild(pre),announcePostCollection.appendChild(div)}const limitValue=7,loadMore=document.querySelector("#loadMore"),getPosts=async()=>{db.collection("posts").orderBy("createdAt","desc").limit(7).get().then(snapshot=>{snapshot.docs.forEach(doc=>{createPost(doc)})}).catch(err=>{console.log(err)})},getAnnouncePosts=async()=>{db.collection("announce").limit(7).orderBy("aPostEnd","desc").get().then(snapshot=>{snapshot.docs.forEach(aDoc=>{createAnnouncePost(aDoc)})}).catch(aErr=>{console.log(aErr)})};window.addEventListener("DOMContentLoaded",(function(){getPosts(),getAnnouncePosts()})),loadMore.addEventListener("click",(function(){getPosts()}));const loader=document.querySelector(".loadObject"),loadAni=document.querySelector(".loadingAni");btnLogin.onclick=()=>{"kngSMA2021"===txtPass.value?auth.signInWithPopup(provider):alert("⚠ ログインできません")},auth.onAuthStateChanged(user=>{if(user){loader.remove(),whenSignedIn.hidden=!1,whenSignedOut.hidden=!0,addFeature.hidden=!1,postButtons.hidden=!1,announcePostButton.hidden=!1,addSite.hidden=!1,loginPopUp.innerHTML=`<button class="close" onclick="loginPopUpFunction()"></button>ログイン済みです！<br><h3>${user.displayName}さん、SMAダッシュボードへようこそ 🎉</h3>`,document.querySelector("#publishPost").addEventListener("click",(function(){let postDate=document.querySelector("#postDate").value,postTitle=document.querySelector("#postTitle").value,postAuthor=document.querySelector("#postAuthor").value,postContent=document.querySelector("#postContent").value;function radioValueFunction(){for(let i=0;i<radios.length;i++)if(radios[i].checked)return radios[i].value}""===postDate||""===postTitle||""===postAuthor||""===postContent?alert("全ての欄を記入してください"):db.collection("posts").doc().set({createdAt:postDate,postName:postTitle,postAuthor:postAuthor,postContent:postContent,postType:radioValueFunction(),postLike:0}),document.getElementById("createPost").hidden=!0})),document.querySelector("#publishAnnounce").addEventListener("click",(function(){let announceTitle=document.querySelector("#announceTitle").value,announceStartDate=document.querySelector("#announceStartDate").value,announceEndDate=document.querySelector("#announceEndDate").value,announceContent=document.querySelector("#announceContent").value;""===announceTitle||""===announceStartDate||""===announceEndDate||""===announceContent?alert("全ての欄を記入してください"):db.collection("announce").doc().set({aPostTitle:announceTitle,aPostStart:announceStartDate,aPostEnd:announceEndDate,aPostContent:announceContent}),document.getElementById("announcePopUp").hidden=!0}));const firstName=user.displayName.split(" ")[0],userPostSum=0;var d,h=(new Date).getHours();userDetails.innerHTML=h>12?`<img src="${user.photoURL}"><h3>${firstName}さん<br>こんばんは 🌃</h3><h4>総投稿数：${userPostSum}</h4>`:`<img src="${user.photoURL}"><h3>${firstName}さん<br>こんにちは 🌄</h3><h4>総投稿数：${userPostSum}</h4>`,loadAni.remove()}else whenSignedIn.hidden=!0,whenSignedOut.hidden=!1,addFeature.hidden=!0,addSite.hidden=!0,postButtons.hidden=!0,announcePostButton.hidden=!0,userDetails.innerHTML="",loadAni.remove(),btnWebsiteVerify.onclick=()=>{"kngSMA"===txtWebsitePass.value?loader.remove():alert("⚠ パスワードが間違っています")}});